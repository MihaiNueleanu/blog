name: Automated tagging

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [12.x]
    steps:
      - name: Checkout Git repo
        uses: actions/checkout@master
      - name: Automated Version Bump
        id: versionBump
        uses: TriPSs/conventional-changelog-action@v3
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          output-file: false
          tag-prefix: ""
          skip-on-empty: "false"

      - name: Install SSH Key
        uses: shimataro/ssh-key-action@v2.1.0
        with:
          key: ${{ secrets.KUBERNETES_SSH_KEY_PRIV }}
          known_hosts: |
            github.com ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDmybfj5ppELz83p5uopJaETdudJ4sSLYCI/duykbCo5t5eyGBmmYsTOIlOw7RFkpXIT2++iETZZTQyCN/24nPTqyqQfP5JF1tMbZtqFx26mLg0IWHlx0MSjSaZPHZDRnJLoh3xQoG0Kfognd9iZwDHA42+is7ighPMFLP+nWigkqXslbtsao9nPS6Rs7X2K9YUfoOBljo1jEtrAm7WGoQsUNKO/EaHETe3wpIVvlVeTQii7oV3iJH6dBl5PO0DFbvtXBoy/ZgK4/XnwCvHqsnTGTLwA5IctRsQNgqhAFvTg/ZczlZkQ9/Wa9LWw0nPyO82JpdglDFjm5LapoMBjLShTRNr+cPUQxuR2Ek8OlMG1KiXYF6XlBqbFG1+enPJfIBuANWOEhQ+5aHsHb9t0FpibfbAgxu7fgBV7w+9JdrUCQnGq3XkeLs0SBslbt0EdmBxRmVEUSMH09rkOf/C8h0r6oFrM561YMwR8Afw2MxeVvdXuEf1BNoWcjvNhbz8topTcjYGvncSOZnAv+GDil7wV5mppdXqhb6oKB1w1dnl07VdSFFqVma1Kso+ySZrq27qOR66sEec9rkdC8plHQnDDV13RftYxpGvGG4qGBaxReEib8sUrRDriHm6ItDjtZSGW9gr4z5A2u7uJ5db2g486Gq3dVkisTAgx98SkscusQ== mihai@nueleanu.com
      - name: update repo
        run: |
          # VARIABLES
          TAG="${{ steps.versionBump.outputs.tag }}"
          URL="git@github.com:MihaiNueleanu/kubernetes.git"

          # SETUP
          git config --global user.email "robot@nueleanu.com"
          git config --global user.name "Robot"
          git clone $URL
          cd kubernetes

          # CHANGES
          sed -i "s/release-.*$/release-$TAG/" ./blog/deployment.yaml

          # PUSH
          git remote set-url origin $URL
          git add .
          git commit -m "Release admin version $TAG"
          git push
