name: Automated tagging

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [12.x]
    steps:
      - name: Checkout Git repo
        uses: actions/checkout@master
      - name: Automated Version Bump
        id: versionBump
        uses: TriPSs/conventional-changelog-action@v3
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          output-file: false
          tag-prefix: ""
          skip-on-empty: "false"

      - name: Install SSH Key
        uses: shimataro/ssh-key-action@v2.1.0
        with:
          key: ${{ secrets.KUBERNETES_SSH_KEY_PRIV }}
          known_hosts: |
            github.com ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDQASvUV2IoHovKIj5Gxmn/HrIsWAJNq8+xcFUKzV+RFsm2qqAbVx3ggSzqLRMf7nDtOqdssEaSXqlLJpn+K/Yn09Ga4XOPlgyMwNfN3kC2tvSprW+xaDvy+s+URCos2tAz4gn96DF4umaWiMY9Up+QZkAflF5+sxOqUkUOsNnyrqaFdhvft2OnAsI7JNymr56CGxgDVi0ehCvFcbK32fn5xp9Qkl6srCUi8pa6YKHTEG1vfTN9qjyyrgbDyhUv3TJZz95GlqFeIZaT+efz/dwX+p2R1CQEyQc2nQUDJUFHVB+LvG8RN8HxRpK8epx3WaeBOm7TAagk8aK5f3yTuljCBkKb5jFPAuwlEe3AxB2XW/Bng3dsWJRdSPDdDrfg0d5Cuc8EELh/gFau8z78eyuoXOYl/yn1lH4BTa1Z0iZsHKTCiDUDuLG7ts4k050W4xW9muugDsb5GcimpNzz0vx/zTIxQUvogZ5zdWRTpDiQs/snhP5IRlhMKdXoLwVR8hgGmCJEvTFWusXBLMx+gUNS56zfnbHEc7pE9xdzCSIs8Zt7nEDDZ+cp0zK1wMOI0glMACFBubXjh6QvTF704lVK8zytNlVJcW3mVqZ+ktqgysGXXg9G3dkKQrny/3Yo3G9vPAte5AojuhYgqda2G0xOxr1yUIJe1vJFMDoXfyzccw== minu@crimetech.dk
      - name: update repo
        run: |
          # VARIABLES
          TAG="${{ steps.versionBump.outputs.tag }}"
          URL="git@github.com:MihaiNueleanu/kubernetes.git"

          # SETUP
          git config --global user.email "robot@nueleanu.com"
          git config --global user.name "Robot"
          git clone $URL
          cd kubernetes

          # CHANGES
          sed -i "s/release-.*$/release-$TAG/" ./blog/deployment.yaml

          # PUSH
          git remote set-url origin $URL
          git add .
          git commit -m "Release admin version $TAG"
          git push
